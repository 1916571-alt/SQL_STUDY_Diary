# ğŸ“… 2025-12-27 SQL ë¬¸ì œ í’€ì´ (SolveSQL)

## 1. ì¸í”Œë£¨ì–¸ì„œ ë§ˆì¼€íŒ… í›„ë³´ ì°¾ê¸° (Level 5)

**í•µì‹¬ ê³¼ì œ**: ì¹œêµ¬ì˜ ì¹œêµ¬(2-hop)ê°€ ë§ì€ ìœ ì €ë¥¼ ì°¾ì•„ë¼.

### âŒ ì´ˆê¸° ì‹œë„ ë° ì˜¤ë‹µ ë…¸íŠ¸
ì²˜ìŒì—ëŠ” `user_a_id` ê¸°ì¤€ìœ¼ë¡œ ì¹œêµ¬ ìˆ˜ë¥¼ ì„¼ ë’¤, ë‹¤ì‹œ ì¡°ì¸í•˜ì—¬ í•©ì‚°í•˜ë ¤ê³  í–ˆë‹¤.
í•˜ì§€ë§Œ **ë‹¨ë°©í–¥**ìœ¼ë¡œë§Œ ê´€ê³„ë¥¼ í•´ì„í•œ ê²ƒì´ íŒ¨ì°©ì´ì—ˆë‹¤. ì¹œêµ¬ ê´€ê³„ëŠ” `A -> B`ë¿ë§Œ ì•„ë‹ˆë¼ `B -> A`ë„ ì„±ë¦½í•œë‹¤ëŠ” ì ì„ ê°„ê³¼í–ˆë‹¤.

```sql
-- [ì´ˆê¸° ì ‘ê·¼]
WITH a_user AS (
    SELECT
      user_a_id,
      count(*) as friends_of_friends
    FROM edges
    GROUP BY user_a_id
)
-- (ì´í›„ ì¡°ì¸í•˜ëŠ” ë¡œì§...)
-- ë¬¸ì œì : edges í…Œì´ë¸”ì˜ (A, B) ê´€ê³„ë¥¼ ì–‘ë°©í–¥ìœ¼ë¡œ ê³ ë ¤í•˜ì§€ ì•ŠìŒ.
```

### âœ… í•´ê²° (Correct Solution)
1. **ê´€ê³„ í¼ì¹˜ê¸°**: `UNION ALL`ì„ ì‚¬ìš©í•˜ì—¬ `(A, B)`ì™€ `(B, A)`ë¥¼ ëª¨ë‘ í•˜ë‚˜ì˜ í…Œì´ë¸”(`friends`)ë¡œ ë§Œë“¤ì—ˆë‹¤. (ë¬´ë°©í–¥ ê·¸ë˜í”„í™”)
2. **ì¹œêµ¬ ìˆ˜ ê³„ì‚°**: ê° ìœ ì €ë³„ ì§ì ‘ ì¹œêµ¬ ìˆ˜(`degree`)ë¥¼ êµ¬í•œë‹¤.
3. **ì¹œêµ¬ì˜ ì¹œêµ¬ ìˆ˜ ê³„ì‚°**: ë‚´ ì¹œêµ¬(`f.friend_id`)ê°€ ê°€ì§„ ì¹œêµ¬ ìˆ˜(`d.friends`)ë¥¼ ëª¨ë‘ ë”í•œë‹¤ (`SUM`).

```sql
WITH
-- 1. ë¬´ë°©í–¥ ì¹œêµ¬ ê´€ê³„ í¼ì¹˜ê¸°
friends AS (
    SELECT user_a_id AS user_id, user_b_id AS friend_id FROM edges
    UNION ALL
    SELECT user_b_id AS user_id, user_a_id AS friend_id FROM edges
),

-- 2. ê° ì‚¬ìš©ìë³„ ì¹œêµ¬ ìˆ˜ (degree)
degree AS (
    SELECT
        user_id,
        COUNT(*) AS friends
    FROM friends
    GROUP BY user_id
),

-- 3. í›„ë³´ìë³„ ì¹œêµ¬ë“¤ì˜ ì¹œêµ¬ ìˆ˜ í•©
friends_of_friends AS (
    SELECT
        f.user_id,
        SUM(d.friends) AS friends_of_friends
    FROM friends f
    JOIN degree d
        ON f.friend_id = d.user_id
    GROUP BY f.user_id
)

-- 4. ìµœì¢… í›„ë³´ ì„ ì •
SELECT
    d.user_id,
    d.friends,
    fof.friends_of_friends,
    ROUND(fof.friends_of_friends / d.friends, 2) AS ratio
FROM degree d
JOIN friends_of_friends fof
    ON d.user_id = fof.user_id
WHERE d.friends >= 100
ORDER BY ratio DESC
LIMIT 5;
```

---

## 2. ì—°ë„ë³„ ë°°ì†¡ ì—…ì²´ ì´ìš© ë‚´ì—­ ë¶„ì„í•˜ê¸°

**í•µì‹¬ ê³¼ì œ**: `Standad` ë°°ì†¡ ë°˜í’ˆ ê±´ì€ `Standard` ì´ìš© íšŸìˆ˜ì— 1íšŒ ì¶”ê°€í•˜ì—¬ í•©ì‚°í•´ì•¼ í•œë‹¤.

### ğŸ’¡ ìƒê°ì˜ ë£¨íŠ¸ (Core Insight)
> "ë§Œì•½ ROW ë³„ë¡œ ìˆëŠ” ê°’ì´ íŠ¹ì • ì¡°ê±´ì„ ê¸°ì¤€ìœ¼ë¡œ ì»¬ëŸ¼ì„ ë§Œë“¤ì–´ì„œ SUM í•´ì•¼ í•œë‹¤ë©´?" -> **Pivot (GROUP BY + CASE WHEN)** íŒ¨í„´ì„ ë– ì˜¬ë ¤ì•¼ í•œë‹¤.

### ğŸ“ ì½”ë“œ ë¹„êµ

#### ë°©ë²• 1: CTE + ê°œë³„ ì§‘ê³„ (ì¡°ê¸ˆ ë³µì¡í•¨)
`shipping_method` ë³„ë¡œ ê°ê° `CASE WHEN`ìœ¼ë¡œ ë³€í™˜ í›„, ë‚˜ì¤‘ì— í•©ì¹˜ëŠ” ë°©ì‹.

```sql
WITH base AS(
  SELECT
  year(purchased_at) AS year,
  CASE WHEN shipping_method = 'Standard' THEN count(*) END standard,
  CASE WHEN shipping_method = 'Express' THEN count(*) END Express,
  CASE WHEN shipping_method = 'Overnight' THEN count(*) END overnight,
  sum(is_returned) as retur
FROM transactions
where shipping_method is not null
GROUP BY year, shipping_method
)
-- ë‹¤ì‹œ í•œë²ˆ GROUP BY year ìˆ˜í–‰
SELECT year, SUM(retur) + sum(standard) AS standard, ...
FROM base
GROUP BY year
```

#### ë°©ë²• 2: ê¹”ë”í•œ í•´ê²° (Recommended)
`CASE WHEN` ë‚´ë¶€ì—ì„œ 1ê³¼ 0ì„ ë°˜í™˜í•˜ê²Œ í•˜ê³  ë°”ë¡œ `SUM`ì„ ë•Œë¦°ë‹¤. `Standard`ì˜ ê²½ìš° `is_returned`ë„ ê°™ì´ ë”í•´ì£¼ë©´ í•œ íì— ëë‚œë‹¤.

```sql
SELECT 
    year(purchased_at) AS year,
    -- Standard íšŸìˆ˜ + ë°˜í’ˆ íšŸìˆ˜
    SUM(CASE WHEN shipping_method = 'Standard' THEN 1 ELSE 0 END) + SUM(is_returned) AS standard,
    SUM(CASE WHEN shipping_method = 'Express' THEN 1 ELSE 0 END) AS express,
    SUM(CASE WHEN shipping_method = 'Overnight' THEN 1 ELSE 0 END) AS overnight
FROM transactions
WHERE shipping_method IS NOT NULL
GROUP BY year(purchased_at)
ORDER BY year;
```
