# 📅 2025-12-01 SQL Study Log

## 오랜 기간 보호한 동물(2)
**대분류**: SQL 블로깅
**설명**: STRING, DATE

### 문제
입양을 간 동물 중, 보호 기간이 가장 길었던 동물 두 마리의 아이디와 이름을 조회.

### 풀이 1: Simple ORDER BY
```sql
SELECT I.ANIMAL_ID, I.NAME
FROM ANIMAL_INS I
JOIN ANIMAL_OUTS O
 ON I.ANIMAL_ID = O.ANIMAL_ID
ORDER BY DATEDIFF(O.DATETIME,I.DATETIME) DESC
LIMIT 2
```

### 풀이 2: Window Function (ROW_NUMBER)
```sql
WITH STAY_RANK AS(
SELECT I.ANIMAL_ID,
I.NAME,
DATEDIFF(O.DATETIME,I.DATETIME) AS STAY,
ROW_NUMBER() OVER (ORDER BY DATEDIFF(O.DATETIME,I.DATETIME) DESC) AS RN
FROM ANIMAL_INS I
JOIN ANIMAL_OUTS O
ON I.ANIMAL_ID = O.ANIMAL_ID
)
SELECT ANIMAL_ID, NAME
FROM STAY_RANK
WHERE RN <= 2
ORDER BY RN;
```

### 📝 Note: 순위 함수 차이
- `ROW_NUMBER()`: 동점이어도 무조건 1, 2, 3 (고유 순위)
- `RANK()`: 동점자 처리 후 건너뜀 (1, 1, 3)
- `DENSE_RANK()`: 동점자 처리 후 건너뛰지 않음 (1, 1, 2)

---

## 자동차 대여 기록 별 대여 금액 구하기 (복합 문제)

트럭의 대여 기간별 할인율을 적용하여 금액 계산.

```sql
WITH SALES_GROUP AS(
    SELECT H.HISTORY_ID,C.CAR_TYPE,C.DAILY_FEE,DATEDIFF(H.END_DATE,H.START_DATE) + 1 AS PERIOD,
    CASE
        WHEN (DATEDIFF(H.END_DATE,H.START_DATE) + 1) >= 90 THEN '90일 이상'
        WHEN (DATEDIFF(H.END_DATE,H.START_DATE) + 1) >= 30 THEN '30일 이상'
        WHEN (DATEDIFF(H.END_DATE,H.START_DATE) + 1) >= 7 THEN '7일 이상'
        ELSE 'X' END AS SALES_GROUP
    FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY H
    JOIN CAR_RENTAL_COMPANY_CAR C
    ON H.CAR_ID = C.CAR_ID
    WHERE C.CAR_TYPE = '트럭'
)
SELECT G.HISTORY_ID,
CASE
    WHEN SALES_GROUP = 'X' THEN CAST(DAILY_FEE * PERIOD AS UNSIGNED)
    ELSE CAST((DAILY_FEE*(1-0.01*discount_rate))*period AS UNSIGNED)
END FEE
FROM SALES_GROUP G
LEFT JOIN CAR_RENTAL_COMPANY_DISCOUNT_PLAN P
ON G.CAR_TYPE = P.CAR_TYPE AND G.SALES_GROUP = P.DURATION_TYPE
ORDER BY FEE DESC, G.HISTORY_ID DESC
```
