# 📅 2025-11-23 SQL Study Log

## 1. 조건에 맞는 사원 정보 조회하기 (Level 2)
[Programmers Link](https://school.programmers.co.kr/learn/courses/30/lessons/284527)

### Initial Approach
```sql
SELECT g.SCORE, e.EMP_NO,e.EMP_NAME,e.POSITION,e.EMAIL
FROM HR_DEPARTMENT d
JOIN HR_EMPLOYEES e
ON d.DEPT_ID = e.DEPT_ID
JOIN HR_GRADE g
ON e.EMP_NO = g.EMP_NO
ORDER BY g.SCORE DESC
LIMIT 1
```

### Correction
SCORE를 연도별로 더해야 하므로 `GROUP BY`가 필요했다.

```sql
WITH base as(
SELECT EMP_NO, YEAR, SUM(SCORE) AS SCORE_1
FROM HR_GRADE
GROUP BY EMP_NO, YEAR
)
SELECT SUM(b.SCORE_1) AS SCORE,b.EMP_NO, e.EMP_NAME,e.POSITION,e.EMAIL
FROM base b
JOIN HR_EMPLOYEES e
ON b.EMP_NO = e.EMP_NO
GROUP BY b.EMP_NO
ORDER BY SCORE DESC
LIMIT 1;
```

---

## 2. 노선별 평균 역 사이 거리 조회하기
[Programmers Link](https://school.programmers.co.kr/learn/courses/30/lessons/284531)

### Learning Point
`CONCAT`으로 문자가 된 컬럼을 `ORDER BY`에 쓰면 사전순 정렬이 되어버린다. `ORDER BY`에는 원본 수식을 써야 한다.

```sql
SELECT ROUTE,
CONCAT(ROUND(SUM(D_BETWEEN_DIST),1),'km') AS TOTAL_DISTANCE,
CONCAT(ROUND(AVG(D_BETWEEN_DIST),2),'km') AS AVERAGE_DISTANCE
FROM SUBWAY_DISTANCE
GROUP BY ROUTE
ORDER BY SUM(D_BETWEEN_DIST) DESC
```

---

## 3. 자동차 대여 기록에서 대여중 / 대여 가능 여부 구분하기

### 🔥 핵심 패턴: "조건 만족 여부 판별"

> **Q. 그룹 내에서 조건을 만족하는 row가 하나라도 있으면 True인가?**
> **A. MAX(CASE WHEN ... THEN 1 ELSE 0 END)**

```sql
SELECT
CAR_ID,
CASE
WHEN MAX(CASE WHEN '2022-10-16' BETWEEN START_DATE AND END_DATE
THEN 1 ELSE 0 END) > 0
THEN '대여중'
ELSE '대여 가능'
END AS AVAILABILITY
FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY
GROUP BY CAR_ID
ORDER BY CAR_ID DESC;
```

---

## 4. 즐겨찾기가 가장 많은 식당 정보 출력하기

### 정리: 기억해야 할 기준 트리거

> ▶ **“그룹 안에서 ‘행 전체’를 선택해야 할 때”**
> → **서브쿼리 + JOIN**

> ▶ **“그룹 안에서 ‘조건이 있는지 없는지’만 판단하면 될 때”**
> → **CASE + 집계(SUM/MAX)**

---

## 5. 대여 횟수가 많은 자동차들의 월별 대여 횟수 구하기

```sql
WITH base AS(
SELECT CAR_ID,COUNT(CAR_ID)
FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY
WHERE DATE_FORMAT(START_DATE,'%Y-%m') BETWEEN '2022-08' AND '2022-10'
GROUP BY CAR_iD
HAVING COUNT(CAR_ID)>= 5
)
SELECT MONTH(c.START_DATE) AS MONTH, c.CAR_ID, COUNT(c.CAR_ID) AS RECORDS
FROM base b
JOIN CAR_RENTAL_COMPANY_RENTAL_HISTORY c
ON b.CAR_ID = c.CAR_ID
WHERE DATE_FORMAT(START_DATE,'%Y-%m') BETWEEN '2022-08' AND '2022-10'
AND MONTH(c.START_DATE) IS NOT NULL
GROUP BY MONTH,c.CAR_ID
ORDER BY MONTH, CAR_ID DESC;
```

---

## 기타 문제 풀이

### 조건에 맞는 사용자와 총 거래금액 조회하기
```sql
SELECT u.USER_ID, u.NICKNAME, SUM(PRICE) AS TOTAL_SALES
FROM USED_GOODS_BOARD b
JOIN USED_GOODS_USER u
ON b.WRITER_ID = u.USER_ID
WHERE b.STATUS = 'DONE'
GROUP BY u.USER_ID
HAVING SUM(PRICE) >= 700000
ORDER BY  SUM(PRICE)
```

### 부서별 평균 연봉 조회하기
```sql
SELECT h.DEPT_ID, h.DEPT_NAME_EN,ROUND(AVG(e.SAL),0) AS AVG_SAL
FROM HR_DEPARTMENT h
JOIN HR_EMPLOYEES e
ON h.DEPT_ID = e.DEPT_ID
GROUP BY DEPT_ID
ORDER BY AVG(e.SAL) DESC
```
