# 평균 구매 주기

> **정보**
> - **날짜**: 2026년 01월 21일
> - **분류**: Self-Made (G-1)
> - **주제**: LAG + DATEDIFF
> - **난이도**: ★★★
> - **재풀이 여부**: X

---

### 문제 설명

고객별 평균 구매 주기를 계산하세요.

**테이블**: orders

**출력**: user_id | order_count | avg_purchase_cycle | min_cycle | max_cycle

---

### 정답 풀이

```sql
WITH order_gaps AS (
    SELECT
        user_id,
        order_date,
        LAG(order_date) OVER (PARTITION BY user_id ORDER BY order_date) AS prev_order_date,
        DATEDIFF(order_date,
            LAG(order_date) OVER (PARTITION BY user_id ORDER BY order_date)
        ) AS days_between
    FROM orders
)
SELECT
    user_id,
    COUNT(*) AS order_count,
    ROUND(AVG(days_between), 1) AS avg_purchase_cycle,
    MIN(days_between) AS min_cycle,
    MAX(days_between) AS max_cycle
FROM order_gaps
WHERE days_between IS NOT NULL
GROUP BY user_id
HAVING COUNT(*) >= 2
ORDER BY avg_purchase_cycle;
```

---

### 핵심 포인트

1. **LAG로 이전 주문일**: 구매 간격 계산의 기본
2. **DATEDIFF**: 두 날짜 사이 일수 계산
3. **HAVING 조건**: 2회 이상 구매 고객만 (주기 계산 가능)
