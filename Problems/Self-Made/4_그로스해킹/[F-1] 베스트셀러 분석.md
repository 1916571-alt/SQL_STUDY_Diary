# 베스트셀러 분석

> **정보**
> - **날짜**: 2026년 01월 21일
> - **분류**: Self-Made (F-1)
> - **주제**: 전월 대비 증감
> - **난이도**: ★★★
> - **재풀이 여부**: X

---

### 문제 설명

베스트셀러 상품의 전월 대비 판매량 변화를 분석하세요.

**테이블**: orders, order_items, products

**출력**: year_month | product_name | total_qty | prev_qty | qty_change | qty_growth_rate | monthly_rank

---

### 정답 풀이

```sql
WITH monthly_product_sales AS (
    SELECT
        DATE_FORMAT(o.order_date, '%Y-%m') AS year_month,
        oi.product_id,
        SUM(oi.quantity) AS total_qty,
        SUM(oi.quantity * oi.unit_price) AS total_revenue
    FROM orders o
    JOIN order_items oi ON o.id = oi.order_id
    WHERE YEAR(o.order_date) = 2024
    GROUP BY DATE_FORMAT(o.order_date, '%Y-%m'), oi.product_id
),
with_prev AS (
    SELECT
        year_month,
        product_id,
        total_qty,
        total_revenue,
        LAG(total_qty) OVER (PARTITION BY product_id ORDER BY year_month) AS prev_qty,
        LAG(total_revenue) OVER (PARTITION BY product_id ORDER BY year_month) AS prev_revenue
    FROM monthly_product_sales
)
SELECT
    w.year_month,
    p.name AS product_name,
    w.total_qty,
    w.prev_qty,
    w.total_qty - COALESCE(w.prev_qty, 0) AS qty_change,
    ROUND((w.total_qty - COALESCE(w.prev_qty, w.total_qty)) * 100.0 / NULLIF(w.prev_qty, 0), 2) AS qty_growth_rate,
    RANK() OVER (PARTITION BY w.year_month ORDER BY w.total_revenue DESC) AS monthly_rank
FROM with_prev w
JOIN products p ON w.product_id = p.id
ORDER BY w.year_month, monthly_rank
LIMIT 30;
```

---

### 핵심 포인트

1. **LAG로 전월 데이터**: 동일 상품의 전월 판매량 가져오기
2. **COALESCE**: 첫 달(전월 없음)에 NULL 대신 0 또는 현재값 사용
3. **월별 순위**: RANK()로 해당 월 베스트셀러 순위 계산
