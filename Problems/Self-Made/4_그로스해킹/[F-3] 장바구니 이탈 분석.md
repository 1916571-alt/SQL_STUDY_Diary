# 장바구니 이탈 분석

> **정보**
> - **날짜**: 2026년 01월 21일
> - **분류**: Self-Made (F-3)
> - **주제**: 이탈률
> - **난이도**: ★★★
> - **재풀이 여부**: X

---

### 문제 설명

장바구니에 담았지만 구매하지 않은 비율(이탈률)을 계산하세요.

**테이블**: cart_items, orders, order_items

**출력**: total_cart_items | converted_items | abandoned_items | abandonment_rate | conversion_rate

---

### 정답 풀이

```sql
WITH cart_users AS (
    SELECT DISTINCT user_id, product_id, DATE(added_at) AS cart_date
    FROM cart_items
),
purchased AS (
    SELECT DISTINCT o.user_id, oi.product_id, DATE(o.order_date) AS order_date
    FROM orders o
    JOIN order_items oi ON o.id = oi.order_id
),
cart_analysis AS (
    SELECT
        c.user_id,
        c.product_id,
        c.cart_date,
        CASE WHEN p.user_id IS NOT NULL THEN 1 ELSE 0 END AS converted
    FROM cart_users c
    LEFT JOIN purchased p
        ON c.user_id = p.user_id
        AND c.product_id = p.product_id
        AND p.order_date >= c.cart_date
        AND p.order_date <= DATE_ADD(c.cart_date, INTERVAL 7 DAY)
)
SELECT
    COUNT(*) AS total_cart_items,
    SUM(converted) AS converted_items,
    COUNT(*) - SUM(converted) AS abandoned_items,
    ROUND((COUNT(*) - SUM(converted)) * 100.0 / COUNT(*), 2) AS abandonment_rate,
    ROUND(SUM(converted) * 100.0 / COUNT(*), 2) AS conversion_rate
FROM cart_analysis;
```

---

### 핵심 포인트

1. **전환 기준**: 장바구니 담은 후 7일 이내 구매 여부
2. **LEFT JOIN**: 구매 안 한 경우도 포함
3. **이탈률 공식**: (전체 - 전환) / 전체 × 100
