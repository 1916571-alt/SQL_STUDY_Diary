# 이탈 예측 지표

> **정보**
> - **날짜**: 2026년 01월 21일
> - **분류**: Self-Made (D-5)
> - **주제**: 평균 접속 주기 기반 이탈 예측
> - **난이도**: ★★★
> - **재풀이 여부**: X

---

### 문제 설명

고객별 평균 접속 주기를 계산하고, 이탈 위험 고객을 식별하세요.

**테이블**: login_logs

**출력**: user_id | login_count | avg_login_gap | max_gap | days_since_last_login | churn_risk

---

### 정답 풀이

```sql
WITH login_gaps AS (
    SELECT
        user_id,
        login_date,
        LAG(login_date) OVER (PARTITION BY user_id ORDER BY login_date) AS prev_login,
        DATEDIFF(login_date,
            LAG(login_date) OVER (PARTITION BY user_id ORDER BY login_date)
        ) AS days_gap
    FROM login_logs
)
SELECT
    user_id,
    COUNT(*) AS login_count,
    ROUND(AVG(days_gap), 1) AS avg_login_gap,
    MAX(days_gap) AS max_gap,
    DATEDIFF(CURDATE(), MAX(login_date)) AS days_since_last_login,
    CASE
        WHEN DATEDIFF(CURDATE(), MAX(login_date)) > AVG(days_gap) * 2 THEN '이탈 위험'
        WHEN DATEDIFF(CURDATE(), MAX(login_date)) > AVG(days_gap) THEN '주의'
        ELSE '정상'
    END AS churn_risk
FROM login_gaps
GROUP BY user_id
HAVING COUNT(*) > 1
ORDER BY days_since_last_login DESC;
```

---

### 핵심 포인트

1. **LAG로 이전 로그인 일자**: 로그인 간격 계산의 기본
2. **평균 접속 주기**: 고객의 평소 패턴 파악
3. **이탈 판단 기준**: 마지막 접속이 평균 주기의 2배 이상이면 이탈 위험
