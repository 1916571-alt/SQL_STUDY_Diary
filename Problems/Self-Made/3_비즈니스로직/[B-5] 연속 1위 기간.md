# 연속 1위 기간

> **정보**
> - **날짜**: 2026년 01월 21일
> - **분류**: Self-Made (B-5)
> - **주제**: 윈도우 함수 - 연속 패턴 고급
> - **난이도**: ★★★★
> - **재풀이 여부**: X

---

### 문제 설명

월별 매출 1위를 연속으로 유지한 상품과 그 최장 기간을 구하세요.

**테이블**: orders, order_items, products

**출력**: product_name | consecutive_months

---

### 정답 풀이

```sql
WITH monthly_sales AS (
    SELECT
        DATE_FORMAT(o.order_date, '%Y-%m') AS year_month,
        oi.product_id,
        SUM(oi.quantity * oi.unit_price) AS revenue
    FROM orders o
    JOIN order_items oi ON o.id = oi.order_id
    GROUP BY year_month, oi.product_id
),
ranked AS (
    SELECT
        year_month,
        product_id,
        revenue,
        RANK() OVER (PARTITION BY year_month ORDER BY revenue DESC) AS rnk
    FROM monthly_sales
),
top_products AS (
    SELECT
        year_month,
        product_id,
        ROW_NUMBER() OVER (ORDER BY year_month) AS month_num,
        ROW_NUMBER() OVER (PARTITION BY product_id ORDER BY year_month) AS product_seq
    FROM ranked
    WHERE rnk = 1
),
grouped AS (
    SELECT
        product_id,
        month_num - product_seq AS grp
    FROM top_products
)
SELECT
    p.name AS product_name,
    COUNT(*) AS consecutive_months
FROM grouped g
JOIN products p ON g.product_id = p.id
GROUP BY g.product_id, g.grp, p.name
ORDER BY consecutive_months DESC
LIMIT 5;
```

---

### 핵심 포인트

1. **연속 패턴 탐지**: `ROW_NUMBER() - ROW_NUMBER()` 기법으로 연속 그룹 식별
2. **차이 일정 원리**: 연속된 값이면 두 ROW_NUMBER의 차이가 동일
3. **grp 컬럼**: 같은 grp 값을 가진 행들이 연속된 1위 기간
