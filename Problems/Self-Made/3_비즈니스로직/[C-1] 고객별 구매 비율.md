# 고객별 구매 비율

> **정보**
> - **날짜**: 2026년 01월 21일
> - **분류**: Self-Made (C-1)
> - **주제**: 윈도우 함수 - 집계+비율+순위 통합
> - **난이도**: ★★★
> - **재풀이 여부**: X

---

### 문제 설명

고객별 전체 매출 대비 비율과 누적 비율을 계산하세요. 상위 20명을 출력합니다.

**테이블**: orders, users

**출력**: customer_name | total_revenue | revenue_share | cumulative_share | revenue_rank

---

### 정답 풀이

```sql
WITH customer_sales AS (
    SELECT
        user_id,
        SUM(total_amount) AS total_revenue
    FROM orders
    WHERE YEAR(order_date) = 2024
    GROUP BY user_id
)
SELECT
    u.name AS customer_name,
    cs.total_revenue,
    ROUND(cs.total_revenue * 100.0 / SUM(cs.total_revenue) OVER (), 2) AS revenue_share,
    ROUND(SUM(cs.total_revenue) OVER (ORDER BY cs.total_revenue DESC) * 100.0
        / SUM(cs.total_revenue) OVER (), 2) AS cumulative_share,
    RANK() OVER (ORDER BY cs.total_revenue DESC) AS revenue_rank
FROM customer_sales cs
JOIN users u ON cs.user_id = u.id
ORDER BY cs.total_revenue DESC
LIMIT 20;
```

---

### 핵심 포인트

1. **SUM() OVER ()**: 빈 괄호는 전체 합계 (파티션 없음)
2. **누적 비율**: `SUM() OVER (ORDER BY ...)` 로 누적합 계산
3. **파레토 분석**: 상위 20% 고객이 전체 매출의 몇 %인지 확인 가능
