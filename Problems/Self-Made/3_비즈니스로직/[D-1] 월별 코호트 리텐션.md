# 월별 코호트 리텐션

> **정보**
> - **날짜**: 2026년 01월 21일
> - **분류**: Self-Made (D-1)
> - **주제**: 코호트 분석 기초
> - **난이도**: ★★★
> - **재풀이 여부**: X

---

### 문제 설명

가입 월 기준 코호트별로 N개월 후 리텐션율을 계산하세요.

**테이블**: orders

**출력**: cohort_month | cohort_users | month_number | retained_users | retention_rate

---

### 정답 풀이

```sql
WITH first_order AS (
    SELECT
        user_id,
        DATE_FORMAT(MIN(order_date), '%Y-%m') AS cohort_month
    FROM orders
    GROUP BY user_id
),
monthly_activity AS (
    SELECT
        o.user_id,
        f.cohort_month,
        TIMESTAMPDIFF(MONTH,
            STR_TO_DATE(CONCAT(f.cohort_month, '-01'), '%Y-%m-%d'),
            STR_TO_DATE(CONCAT(DATE_FORMAT(o.order_date, '%Y-%m'), '-01'), '%Y-%m-%d')
        ) AS month_number
    FROM orders o
    JOIN first_order f ON o.user_id = f.user_id
),
cohort_size AS (
    SELECT cohort_month, COUNT(DISTINCT user_id) AS cohort_users
    FROM first_order
    GROUP BY cohort_month
)
SELECT
    ma.cohort_month,
    cs.cohort_users,
    ma.month_number,
    COUNT(DISTINCT ma.user_id) AS retained_users,
    ROUND(COUNT(DISTINCT ma.user_id) * 100.0 / cs.cohort_users, 2) AS retention_rate
FROM monthly_activity ma
JOIN cohort_size cs ON ma.cohort_month = cs.cohort_month
WHERE ma.month_number <= 6
GROUP BY ma.cohort_month, cs.cohort_users, ma.month_number
ORDER BY ma.cohort_month, ma.month_number;
```

---

### 핵심 포인트

1. **코호트 정의**: 첫 구매월 기준으로 고객 그룹핑
2. **TIMESTAMPDIFF**: 두 날짜 사이의 월 수 계산
3. **리텐션율**: 해당 월에 활동한 유저 / 코호트 전체 유저 × 100
