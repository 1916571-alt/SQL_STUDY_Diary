# 구간별 매출 비중

> **정보**
> - **날짜**: 2026년 01월 21일
> - **분류**: Self-Made (C-7)
> - **주제**: 윈도우 함수 - 파레토 분석
> - **난이도**: ★★
> - **재풀이 여부**: X

---

### 문제 설명

고객별 매출을 계산하고, 상위 20% 고객이 전체 매출의 몇 %를 차지하는지 분석하세요.

**테이블**: orders

**출력**: customer_segment | customer_count | segment_revenue | revenue_percentage

---

### 정답 풀이

```sql
WITH customer_revenue AS (
    SELECT
        user_id,
        SUM(total_amount) AS total_revenue
    FROM orders
    WHERE YEAR(order_date) = 2024
    GROUP BY user_id
),
ranked AS (
    SELECT
        user_id,
        total_revenue,
        SUM(total_revenue) OVER (ORDER BY total_revenue DESC) AS cumulative_revenue,
        SUM(total_revenue) OVER () AS grand_total,
        ROW_NUMBER() OVER (ORDER BY total_revenue DESC) AS rn,
        COUNT(*) OVER () AS total_customers
    FROM customer_revenue
)
SELECT
    CASE
        WHEN rn <= total_customers * 0.2 THEN 'Top 20%'
        WHEN rn <= total_customers * 0.5 THEN 'Middle 30%'
        ELSE 'Bottom 50%'
    END AS customer_segment,
    COUNT(*) AS customer_count,
    SUM(total_revenue) AS segment_revenue,
    ROUND(SUM(total_revenue) / MAX(grand_total) * 100, 2) AS revenue_percentage
FROM ranked
GROUP BY
    CASE
        WHEN rn <= total_customers * 0.2 THEN 'Top 20%'
        WHEN rn <= total_customers * 0.5 THEN 'Middle 30%'
        ELSE 'Bottom 50%'
    END
ORDER BY revenue_percentage DESC;
```

---

### 핵심 포인트

1. **파레토 법칙**: 80/20 법칙 - 상위 20%가 80% 매출 차지하는지 확인
2. **ROW_NUMBER로 순위**: 매출 순위를 매겨 상위 N% 분류
3. **CASE + GROUP BY**: 같은 CASE 표현식으로 세그먼트 분류 및 집계
