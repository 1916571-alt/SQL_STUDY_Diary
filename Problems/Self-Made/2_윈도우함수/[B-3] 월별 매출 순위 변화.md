# 월별 매출 순위 변화

> **정보**
> - **날짜**: 2026년 01월 21일
> - **분류**: Self-Made (B-3)
> - **주제**: 윈도우 함수 - LAG로 순위 비교
> - **난이도**: ★★★
> - **재풀이 여부**: X

---

### 문제 설명

상품별 월별 매출 순위와 전월 대비 순위 변화를 분석하세요.

**테이블**: orders, order_items

**출력**: year_month | product_id | monthly_revenue | current_rank | prev_rank | rank_change

---

### 정답 풀이

```sql
WITH monthly_sales AS (
    SELECT
        DATE_FORMAT(o.order_date, '%Y-%m') AS year_month,
        oi.product_id,
        SUM(oi.quantity * oi.unit_price) AS monthly_revenue
    FROM order_items oi
    JOIN orders o ON o.id = oi.order_id
    GROUP BY year_month, oi.product_id
),
ranked AS (
    SELECT
        year_month,
        product_id,
        monthly_revenue,
        RANK() OVER (
            PARTITION BY year_month
            ORDER BY monthly_revenue DESC
        ) AS current_rank
    FROM monthly_sales
),
with_prev AS (
    SELECT
        year_month,
        product_id,
        monthly_revenue,
        current_rank,
        LAG(current_rank) OVER (
            PARTITION BY product_id
            ORDER BY year_month
        ) AS prev_rank
    FROM ranked
)
SELECT
    year_month,
    product_id,
    monthly_revenue,
    current_rank,
    prev_rank,
    CASE
        WHEN prev_rank IS NULL THEN 'NEW'
        WHEN current_rank < prev_rank THEN '상승'
        WHEN current_rank > prev_rank THEN '하락'
        ELSE '유지'
    END AS rank_change
FROM with_prev
ORDER BY year_month, current_rank, product_id;
```

---

### 핵심 포인트

1. **2단계 윈도우 함수**: 먼저 RANK로 순위 → LAG로 전월 순위 비교
2. **PARTITION 기준 변경**: RANK는 월별, LAG는 상품별
3. **순위 변화 해석**: current < prev면 순위 상승 (숫자가 작아졌으니까)
