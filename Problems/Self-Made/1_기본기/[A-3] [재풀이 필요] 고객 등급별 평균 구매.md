# 고객 등급별 평균 구매 금액

> **정보**
> - **날짜**: 2025년 01월 20일
> - **분류**: Self-Made (A-3)
> - **주제**: GROUP BY + CTE
> - **난이도**: ★★
> - **재풀이 여부**: O

---

### 문제 설명
고객 등급(Gold, Silver, Bronze)별로
평균 주문 금액, 평균 주문 건수, 총 고객 수를 구하세요.
단, 2024년에 주문한 고객만 대상입니다.

**테이블**: users, orders
**출력**: grade | avg_order_amount | avg_order_count | user_count

---

### 내 풀이

```sql
WITH base AS (
    SELECT user_id,
           SUM(total_amount) AS order_amount,
           COUNT(*) AS order_count
    FROM orders
    WHERE YEAR(order_date) = 2024
    GROUP BY user_id
)
SELECT u.grade,
       AVG(order_amount) AS avg_order_amount,
       AVG(order_count) AS avg_order_count,
       COUNT(b.user_id) AS user_count
FROM base b
JOIN users u ON b.user_id = u.id
GROUP BY u.grade;
```

**확인 필요 사항**:
- 로직은 맞아 보이나, 실제 데이터로 검증 필요
- "2024년에 주문한 고객만" 조건이 CTE에서 처리되고 있음

---

### 배운 점
- **CTE 활용**: 복잡한 집계를 단계별로 처리
- 고객별 집계 → 등급별 집계 (2단계 집계)
