# 작가별 판매 통계

> **정보**
> - **날짜**: 2025년 01월 20일
> - **분류**: Self-Made (A-1)
> - **주제**: 복합 JOIN
> - **난이도**: ★★★
> - **재풀이 여부**: O

---

### 문제 설명
2024년에 가장 많이 팔린 상위 5명의 작가들에 대해,
작가 이름, 총 판매 권수, 평균 평점(소수점 둘째자리),
평점을 받은 책의 개수를 판매량이 많은 순으로 출력하세요.

**테이블**: authors, books, book_orders, reviews
**출력**: author_name | total_sales | avg_rating | rated_book_cnt

---

### 오답 풀이

```sql
SELECT a.name AS author_name,
       SUM(bo.quantity) AS total_sales,
       ROUND(AVG(rating), 2) AS avg_rating,
       COUNT(r.id) AS rated_book_cnt
FROM book_orders bo
JOIN books b ON bo.book_id = b.id
JOIN authors a ON b.author_id = a.id
JOIN reviews r ON r.book_id = bo.book_id
GROUP BY a.name
ORDER BY total_sales;
```

**문제점**:
1. **2024년 조건 누락**: `WHERE YEAR(bo.order_date) = 2024` 필요
2. **LIMIT 5 누락**: 상위 5명만 출력해야 함
3. **ORDER BY DESC 누락**: 판매량 많은 순 = 내림차순
4. **JOIN 방식 문제**: reviews와 book_orders를 직접 조인하면 중복 발생 가능

---

### 정답 풀이

```sql
WITH author_sales AS (
    SELECT b.author_id,
           SUM(bo.quantity) AS total_sales
    FROM book_orders bo
    JOIN books b ON bo.book_id = b.id
    WHERE YEAR(bo.order_date) = 2024
    GROUP BY b.author_id
    ORDER BY total_sales DESC
    LIMIT 5
),
author_ratings AS (
    SELECT b.author_id,
           ROUND(AVG(r.rating), 2) AS avg_rating,
           COUNT(DISTINCT r.book_id) AS rated_book_cnt
    FROM reviews r
    JOIN books b ON r.book_id = b.id
    GROUP BY b.author_id
)
SELECT a.name AS author_name,
       s.total_sales,
       COALESCE(ar.avg_rating, 0) AS avg_rating,
       COALESCE(ar.rated_book_cnt, 0) AS rated_book_cnt
FROM author_sales s
JOIN authors a ON s.author_id = a.id
LEFT JOIN author_ratings ar ON s.author_id = ar.author_id
ORDER BY s.total_sales DESC;
```

---

### 배운 점
- **조건 확인**: 문제의 모든 조건을 빠뜨리지 않기 (연도, LIMIT, 정렬 방향)
- **중복 방지**: 여러 테이블 JOIN 시 중복 카운트 주의 → CTE로 분리하여 집계
- **COALESCE**: 리뷰가 없는 작가도 포함하려면 LEFT JOIN + COALESCE 사용
