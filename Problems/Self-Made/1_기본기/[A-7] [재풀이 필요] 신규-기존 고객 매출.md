# 신규/기존 고객 매출

> **정보**
> - **날짜**: 2026년 01월 21일
> - **분류**: Self-Made (A-7)
> - **주제**: CTE + 조건 분기
> - **난이도**: ★★★
> - **재풀이 여부**: O

---

### 문제 설명

2024년 각 월별로 신규 고객(해당 월 첫 구매)과 기존 고객(이전 구매 이력 있음)의 매출액을 각각 구하세요.

- 신규 고객: 그 달에 생애 첫 구매를 한 고객
- 기존 고객: 이전에 구매 이력이 있는 고객

**테이블**: orders (id, user_id, total_amount, order_date)

**출력**: year_month | new_customer_revenue | existing_customer_revenue

---

### 오답 풀이

```sql
-- 실행 환경 문제로 에러 발생
WITH first_purchase AS (
    SELECT user_id,
           DATE_FORMAT(MIN(order_date), '%Y-%m') AS first_month
    FROM orders
    GROUP BY user_id
),
monthly_total AS (
    SELECT DATE_FORMAT(order_date, '%Y-%m') AS year_month,
           SUM(total_amount) AS total_revenue
    FROM orders
    WHERE YEAR(order_date) = 2024
    GROUP BY DATE_FORMAT(order_date, '%Y-%m')
),
monthly_new AS (
    SELECT DATE_FORMAT(o.order_date, '%Y-%m') AS year_month,
           SUM(o.total_amount) AS new_customer_revenue
    FROM orders o
    JOIN first_purchase f ON o.user_id = f.user_id
    WHERE YEAR(o.order_date) = 2024
      AND DATE_FORMAT(o.order_date, '%Y-%m') = f.first_month
    GROUP BY DATE_FORMAT(o.order_date, '%Y-%m')
)
SELECT t.year_month,
       IFNULL(n.new_customer_revenue, 0) AS new_customer_revenue,
       t.total_revenue - IFNULL(n.new_customer_revenue, 0) AS existing_customer_revenue
FROM monthly_total t
LEFT JOIN monthly_new n ON t.year_month = n.year_month
ORDER BY t.year_month;
```

**문제점**: SQL 실행 환경에서 문법 에러 발생. 재확인 필요.

---

### 정답 풀이 (CASE WHEN 방식)

```sql
WITH first_purchase AS (
    SELECT user_id,
           DATE_FORMAT(MIN(order_date), '%Y-%m') AS first_month
    FROM orders
    GROUP BY user_id
)
SELECT DATE_FORMAT(o.order_date, '%Y-%m') AS year_month,
       SUM(CASE WHEN DATE_FORMAT(o.order_date, '%Y-%m') = f.first_month
                THEN o.total_amount ELSE 0 END) AS new_customer_revenue,
       SUM(CASE WHEN DATE_FORMAT(o.order_date, '%Y-%m') != f.first_month
                THEN o.total_amount ELSE 0 END) AS existing_customer_revenue
FROM orders o
JOIN first_purchase f ON o.user_id = f.user_id
WHERE YEAR(o.order_date) = 2024
GROUP BY DATE_FORMAT(o.order_date, '%Y-%m')
ORDER BY year_month;
```

---

### 배운 점

1. **신규 고객 정의**: 주문 월 = 해당 유저의 첫 구매 월
2. **두 가지 접근법**:
   - 총 매출 - 신규 매출 = 기존 매출
   - CASE WHEN으로 한 번에 분기 (더 효율적)
3. **CASE WHEN 효율성**: 테이블을 한 번만 스캔하면서 두 값을 동시에 계산 가능
