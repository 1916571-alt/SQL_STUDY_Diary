# 재구매율 계산

> **정보**
> - **날짜**: 2026년 01월 21일
> - **분류**: Self-Made (A-5)
> - **주제**: JOIN + 집계 복합
> - **난이도**: ★★★
> - **재풀이 여부**: X

---

### 문제 설명

2024년 상반기(1-6월)에 첫 구매한 고객 중 하반기(7-12월)에 재구매한 고객의 비율을 구하세요. 소수점 둘째자리까지 표시합니다.

**테이블**: orders (id, user_id, order_date)

**출력**: first_half_customers | repurchase_customers | repurchase_rate

---

### 오답 풀이

```sql
-- 오답 1: repurchase CTE에서 base 테이블 사용
), repurchase as (
  SELECT b.user_id as repurchase
  FROM base b
  join first_half fh on b.user_id = fh.user_id
  where DATE_FORMAT(b.order_date2,'%Y-%m') BETWEEN '2024-07' and '2024-12'
)
```

**문제점**: `base`는 유저별 첫 구매일만 있음. 상반기에 첫 구매한 유저의 첫 구매일이 하반기일 수 없음 (논리적 모순). 하반기 재구매를 확인하려면 원본 `orders` 테이블에서 찾아야 함.

```sql
-- 오답 2: DISTINCT 누락
SELECT o.user_id as repurchase
FROM orders o
```

**문제점**: 한 유저가 하반기에 여러 번 주문하면 중복됨. `DISTINCT` 필요.

---

### 정답 풀이

```sql
WITH base AS (
    SELECT user_id,
           MIN(order_date) AS order_date2
    FROM orders
    GROUP BY user_id
),
first_half AS (
    SELECT user_id
    FROM base
    WHERE DATE_FORMAT(order_date2, '%Y-%m') BETWEEN '2024-01' AND '2024-06'
),
repurchase AS (
    SELECT DISTINCT o.user_id AS repurchase
    FROM orders o
    JOIN first_half fh ON o.user_id = fh.user_id
    WHERE DATE_FORMAT(o.order_date, '%Y-%m') BETWEEN '2024-07' AND '2024-12'
)
SELECT COUNT(fh.user_id) AS first_half_customers,
       COUNT(r.repurchase) AS repurchase_customers,
       COUNT(r.repurchase) / COUNT(fh.user_id) AS repurchase_rate
FROM first_half fh
LEFT JOIN repurchase r ON fh.user_id = r.repurchase;
```

---

### 배운 점

1. **base vs orders 구분**: `base`는 GROUP BY된 결과(첫 구매일)이고, 재구매 확인은 원본 `orders`에서 해야 함
2. **DISTINCT 필요 여부**: GROUP BY된 테이블은 이미 유니크하지만, 원본 테이블에서 가져올 땐 중복 가능
3. **LEFT JOIN 사용**: 재구매 안 한 유저도 포함해야 상반기 전체 고객 수가 정확히 나옴
