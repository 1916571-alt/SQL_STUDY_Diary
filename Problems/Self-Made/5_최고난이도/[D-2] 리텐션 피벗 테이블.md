# 리텐션 피벗 테이블

> **정보**
> - **날짜**: 2026년 01월 23일
> - **분류**: Self-Made (D-2)
> - **주제**: CASE WHEN 피벗으로 리텐션 테이블 생성
> - **난이도**: ★★★★
> - **재풀이 여부**: X

---

### 문제 설명

코호트별 월간 리텐션율을 피벗 테이블 형태로 출력하세요.
행: 코호트(가입월), 열: Month 0 ~ Month 6 리텐션율

**테이블**: orders, users

**출력**: cohort_month | cohort_size | M0 | M1 | M2 | M3 | M4 | M5 | M6

---

### 정답 풀이

```sql
WITH first_order AS (
    SELECT
        user_id,
        DATE_FORMAT(MIN(order_date), '%Y-%m') AS cohort_month
    FROM orders
    GROUP BY user_id
),
monthly_activity AS (
    SELECT
        f.cohort_month,
        f.user_id,
        TIMESTAMPDIFF(MONTH,
            STR_TO_DATE(CONCAT(f.cohort_month, '-01'), '%Y-%m-%d'),
            STR_TO_DATE(CONCAT(DATE_FORMAT(o.order_date, '%Y-%m'), '-01'), '%Y-%m-%d')
        ) AS month_number
    FROM orders o
    JOIN first_order f ON o.user_id = f.user_id
),
cohort_size AS (
    SELECT
        cohort_month,
        COUNT(DISTINCT user_id) AS users
    FROM first_order
    GROUP BY cohort_month
),
retention_counts AS (
    SELECT
        cohort_month,
        month_number,
        COUNT(DISTINCT user_id) AS retained
    FROM monthly_activity
    WHERE month_number BETWEEN 0 AND 6
    GROUP BY cohort_month, month_number
)
SELECT
    cs.cohort_month,
    cs.users AS cohort_size,
    MAX(CASE WHEN rc.month_number = 0 THEN ROUND(rc.retained * 100.0 / cs.users, 1) END) AS M0,
    MAX(CASE WHEN rc.month_number = 1 THEN ROUND(rc.retained * 100.0 / cs.users, 1) END) AS M1,
    MAX(CASE WHEN rc.month_number = 2 THEN ROUND(rc.retained * 100.0 / cs.users, 1) END) AS M2,
    MAX(CASE WHEN rc.month_number = 3 THEN ROUND(rc.retained * 100.0 / cs.users, 1) END) AS M3,
    MAX(CASE WHEN rc.month_number = 4 THEN ROUND(rc.retained * 100.0 / cs.users, 1) END) AS M4,
    MAX(CASE WHEN rc.month_number = 5 THEN ROUND(rc.retained * 100.0 / cs.users, 1) END) AS M5,
    MAX(CASE WHEN rc.month_number = 6 THEN ROUND(rc.retained * 100.0 / cs.users, 1) END) AS M6
FROM cohort_size cs
LEFT JOIN retention_counts rc ON cs.cohort_month = rc.cohort_month
GROUP BY cs.cohort_month, cs.users
ORDER BY cs.cohort_month;
```

---

### 대안: 절대 수치 + 비율 동시 출력

```sql
WITH first_order AS (
    SELECT user_id, DATE_FORMAT(MIN(order_date), '%Y-%m') AS cohort_month
    FROM orders
    GROUP BY user_id
),
activity AS (
    SELECT
        f.cohort_month,
        f.user_id,
        TIMESTAMPDIFF(MONTH,
            STR_TO_DATE(CONCAT(f.cohort_month, '-01'), '%Y-%m-%d'),
            STR_TO_DATE(CONCAT(DATE_FORMAT(o.order_date, '%Y-%m'), '-01'), '%Y-%m-%d')
        ) AS month_num
    FROM orders o
    JOIN first_order f ON o.user_id = f.user_id
),
cohort_users AS (
    SELECT cohort_month, COUNT(DISTINCT user_id) AS size
    FROM first_order
    GROUP BY cohort_month
)
SELECT
    cu.cohort_month,
    cu.size,
    COUNT(DISTINCT CASE WHEN a.month_num = 0 THEN a.user_id END) AS M0_users,
    COUNT(DISTINCT CASE WHEN a.month_num = 1 THEN a.user_id END) AS M1_users,
    COUNT(DISTINCT CASE WHEN a.month_num = 2 THEN a.user_id END) AS M2_users,
    COUNT(DISTINCT CASE WHEN a.month_num = 3 THEN a.user_id END) AS M3_users,
    ROUND(COUNT(DISTINCT CASE WHEN a.month_num = 1 THEN a.user_id END) * 100.0 / cu.size, 1) AS M1_pct,
    ROUND(COUNT(DISTINCT CASE WHEN a.month_num = 2 THEN a.user_id END) * 100.0 / cu.size, 1) AS M2_pct,
    ROUND(COUNT(DISTINCT CASE WHEN a.month_num = 3 THEN a.user_id END) * 100.0 / cu.size, 1) AS M3_pct
FROM cohort_users cu
LEFT JOIN activity a ON cu.cohort_month = a.cohort_month
GROUP BY cu.cohort_month, cu.size
ORDER BY cu.cohort_month;
```

---

### 핵심 포인트

1. **코호트 정의**: 첫 구매월 기준으로 사용자 그룹핑
2. **TIMESTAMPDIFF(MONTH, ...)**: 두 날짜 사이의 월 수 계산
3. **CASE WHEN 피벗**: 행 데이터를 열로 변환
4. **MAX + GROUP BY**: 피벗 시 집계 함수 필수
5. **M0 = 100%**: 코호트 첫 달은 항상 100%

---

### 실무 활용

- 어느 코호트의 리텐션이 좋은지 비교
- 시간에 따른 리텐션 추세 파악
- 제품 개선 전후 리텐션 변화 측정
