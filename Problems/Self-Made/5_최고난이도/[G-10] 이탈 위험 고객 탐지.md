# 이탈 위험 고객 탐지

> **정보**
> - **날짜**: 2026년 01월 23일
> - **분류**: Self-Made (G-10)
> - **주제**: 복합 조건을 활용한 이탈 예측
> - **난이도**: ★★★★
> - **재풀이 여부**: X

---

### 문제 설명

다음 조건을 조합하여 이탈 위험 고객을 탐지하세요:
1. 마지막 구매 후 평균 구매 주기의 2배 이상 경과
2. 최근 90일 내 구매 없음
3. 이전에 2회 이상 구매 이력 있음
4. RFM 점수 기반 위험 세그먼트

**테이블**: orders, users

**출력**: user_id | name | last_order_date | avg_cycle | days_since_last | order_count | total_spent | risk_level

---

### 정답 풀이

```sql
WITH order_stats AS (
    SELECT
        user_id,
        COUNT(*) AS order_count,
        SUM(total_amount) AS total_spent,
        MIN(order_date) AS first_order,
        MAX(order_date) AS last_order,
        DATEDIFF(CURDATE(), MAX(order_date)) AS days_since_last
    FROM orders
    GROUP BY user_id
),
order_gaps AS (
    SELECT
        user_id,
        AVG(DATEDIFF(order_date, prev_date)) AS avg_cycle
    FROM (
        SELECT
            user_id,
            order_date,
            LAG(order_date) OVER (PARTITION BY user_id ORDER BY order_date) AS prev_date
        FROM orders
    ) sub
    WHERE prev_date IS NOT NULL
    GROUP BY user_id
),
rfm_scores AS (
    SELECT
        user_id,
        NTILE(5) OVER (ORDER BY days_since_last DESC) AS r_score,
        NTILE(5) OVER (ORDER BY order_count) AS f_score,
        NTILE(5) OVER (ORDER BY total_spent) AS m_score
    FROM order_stats
),
risk_analysis AS (
    SELECT
        os.user_id,
        os.order_count,
        os.total_spent,
        os.last_order,
        os.days_since_last,
        COALESCE(og.avg_cycle, 30) AS avg_cycle,
        rs.r_score,
        rs.f_score,
        rs.m_score,
        -- 위험 조건 체크
        CASE WHEN os.days_since_last > COALESCE(og.avg_cycle, 30) * 2 THEN 1 ELSE 0 END AS over_cycle,
        CASE WHEN os.days_since_last > 90 THEN 1 ELSE 0 END AS no_purchase_90d,
        CASE WHEN os.order_count >= 2 THEN 1 ELSE 0 END AS repeat_customer,
        CASE WHEN rs.r_score <= 2 AND rs.f_score >= 3 THEN 1 ELSE 0 END AS at_risk_rfm
    FROM order_stats os
    LEFT JOIN order_gaps og ON os.user_id = og.user_id
    LEFT JOIN rfm_scores rs ON os.user_id = rs.user_id
)
SELECT
    ra.user_id,
    u.name,
    ra.last_order AS last_order_date,
    ROUND(ra.avg_cycle, 1) AS avg_cycle,
    ra.days_since_last,
    ra.order_count,
    ra.total_spent,
    CASE
        WHEN ra.over_cycle + ra.no_purchase_90d + ra.at_risk_rfm >= 3 THEN 'Critical'
        WHEN ra.over_cycle + ra.no_purchase_90d + ra.at_risk_rfm >= 2 THEN 'High'
        WHEN ra.over_cycle + ra.no_purchase_90d >= 1 THEN 'Medium'
        ELSE 'Low'
    END AS risk_level,
    CONCAT(ra.r_score, ra.f_score, ra.m_score) AS rfm_score
FROM risk_analysis ra
JOIN users u ON ra.user_id = u.id
WHERE ra.repeat_customer = 1
  AND (ra.over_cycle = 1 OR ra.no_purchase_90d = 1 OR ra.at_risk_rfm = 1)
ORDER BY
    CASE
        WHEN ra.over_cycle + ra.no_purchase_90d + ra.at_risk_rfm >= 3 THEN 1
        WHEN ra.over_cycle + ra.no_purchase_90d + ra.at_risk_rfm >= 2 THEN 2
        ELSE 3
    END,
    ra.total_spent DESC;
```

---

### 이탈 위험 고객 요약 리포트

```sql
WITH risk_customers AS (
    -- (위 쿼리의 risk_analysis CTE까지 동일)
    SELECT
        user_id,
        CASE
            WHEN over_cycle + no_purchase_90d + at_risk_rfm >= 3 THEN 'Critical'
            WHEN over_cycle + no_purchase_90d + at_risk_rfm >= 2 THEN 'High'
            WHEN over_cycle + no_purchase_90d >= 1 THEN 'Medium'
            ELSE 'Low'
        END AS risk_level,
        total_spent
    FROM risk_analysis
    WHERE repeat_customer = 1
)
SELECT
    risk_level,
    COUNT(*) AS customer_count,
    SUM(total_spent) AS total_lifetime_value,
    ROUND(AVG(total_spent), 0) AS avg_ltv,
    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER (), 2) AS pct_of_customers
FROM risk_customers
WHERE risk_level IN ('Critical', 'High', 'Medium')
GROUP BY risk_level
ORDER BY
    CASE risk_level
        WHEN 'Critical' THEN 1
        WHEN 'High' THEN 2
        WHEN 'Medium' THEN 3
    END;
```

---

### 핵심 포인트

1. **복합 조건 조합**: 여러 위험 신호를 점수화하여 종합 판단
2. **평균 구매 주기 활용**: 개인화된 이탈 기준 적용
3. **RFM 연동**: 기존 세그먼트와 결합하여 정확도 향상
4. **CASE 점수화**: 조건 충족 여부를 0/1로 변환 후 합산
5. **가치 기반 우선순위**: LTV 높은 고객 우선 관리

---

### 실무 활용

- 이탈 위험 고객 대상 프로모션/쿠폰 발송
- 고가치 이탈 위험 고객 우선 CS 연락
- 이탈 예방 캠페인 타겟팅
- 이탈률 예측 모델 학습 데이터 생성
