# 퍼널 분석

> **정보**
> - **날짜**: 2026년 01월 23일
> - **분류**: Self-Made (F-4)
> - **주제**: 전환율 단계별 분석
> - **난이도**: ★★★★
> - **재풀이 여부**: X

---

### 문제 설명

앱 이벤트 로그를 분석하여 사용자의 퍼널 전환율을 계산하세요.

**퍼널 단계**: app_open → view_product → add_cart → purchase

각 단계별 도달 사용자 수와 전환율(이전 단계 대비, 첫 단계 대비)을 계산합니다.

**테이블**: app_logs
| 컬럼명 | 타입 | 설명 |
|--------|------|------|
| id | INT | 로그 ID |
| user_id | INT | 사용자 ID |
| event_name | VARCHAR | 이벤트명 |
| event_date | DATE | 이벤트 날짜 |
| event_time | TIME | 이벤트 시간 |

**출력**: step_name | users | prev_step_cvr | first_step_cvr | drop_off_rate

---

### 정답 풀이

```sql
WITH funnel_users AS (
    SELECT
        user_id,
        MAX(CASE WHEN event_name = 'app_open' THEN 1 ELSE 0 END) AS step1_app_open,
        MAX(CASE WHEN event_name = 'view_product' THEN 1 ELSE 0 END) AS step2_view_product,
        MAX(CASE WHEN event_name = 'add_cart' THEN 1 ELSE 0 END) AS step3_add_cart,
        MAX(CASE WHEN event_name = 'purchase' THEN 1 ELSE 0 END) AS step4_purchase
    FROM app_logs
    GROUP BY user_id
),
step_counts AS (
    SELECT
        SUM(step1_app_open) AS step1_users,
        SUM(CASE WHEN step1_app_open = 1 AND step2_view_product = 1 THEN 1 ELSE 0 END) AS step2_users,
        SUM(CASE WHEN step1_app_open = 1 AND step2_view_product = 1 AND step3_add_cart = 1 THEN 1 ELSE 0 END) AS step3_users,
        SUM(CASE WHEN step1_app_open = 1 AND step2_view_product = 1 AND step3_add_cart = 1 AND step4_purchase = 1 THEN 1 ELSE 0 END) AS step4_users
    FROM funnel_users
)
SELECT '1. App Open' AS step_name,
       step1_users AS users,
       100.00 AS prev_step_cvr,
       100.00 AS first_step_cvr,
       0.00 AS drop_off_rate
FROM step_counts
UNION ALL
SELECT '2. View Product',
       step2_users,
       ROUND(step2_users * 100.0 / NULLIF(step1_users, 0), 2),
       ROUND(step2_users * 100.0 / NULLIF(step1_users, 0), 2),
       ROUND(100 - step2_users * 100.0 / NULLIF(step1_users, 0), 2)
FROM step_counts
UNION ALL
SELECT '3. Add Cart',
       step3_users,
       ROUND(step3_users * 100.0 / NULLIF(step2_users, 0), 2),
       ROUND(step3_users * 100.0 / NULLIF(step1_users, 0), 2),
       ROUND(100 - step3_users * 100.0 / NULLIF(step2_users, 0), 2)
FROM step_counts
UNION ALL
SELECT '4. Purchase',
       step4_users,
       ROUND(step4_users * 100.0 / NULLIF(step3_users, 0), 2),
       ROUND(step4_users * 100.0 / NULLIF(step1_users, 0), 2),
       ROUND(100 - step4_users * 100.0 / NULLIF(step3_users, 0), 2)
FROM step_counts;
```

---

### 대안 풀이 (윈도우 함수 활용)

```sql
WITH step_def AS (
    SELECT 1 AS step_order, 'app_open' AS event, 'App Open' AS label
    UNION ALL SELECT 2, 'view_product', 'View Product'
    UNION ALL SELECT 3, 'add_cart', 'Add Cart'
    UNION ALL SELECT 4, 'purchase', 'Purchase'
),
user_max_step AS (
    SELECT
        a.user_id,
        MAX(s.step_order) AS max_step
    FROM app_logs a
    JOIN step_def s ON a.event_name = s.event
    GROUP BY a.user_id
),
step_counts AS (
    SELECT
        s.step_order,
        s.label,
        COUNT(u.user_id) AS users
    FROM step_def s
    LEFT JOIN user_max_step u ON u.max_step >= s.step_order
    GROUP BY s.step_order, s.label
)
SELECT
    label AS step_name,
    users,
    ROUND(users * 100.0 / LAG(users, 1, users) OVER (ORDER BY step_order), 2) AS prev_step_cvr,
    ROUND(users * 100.0 / FIRST_VALUE(users) OVER (ORDER BY step_order), 2) AS first_step_cvr,
    ROUND(100 - users * 100.0 / LAG(users, 1, users) OVER (ORDER BY step_order), 2) AS drop_off_rate
FROM step_counts
ORDER BY step_order;
```

---

### 핵심 포인트

1. **순차적 퍼널**: 이전 단계를 거쳐야만 다음 단계로 카운트
2. **MAX(CASE WHEN)**: 사용자별 각 단계 도달 여부를 플래그화
3. **NULLIF**: 0으로 나누기 방지
4. **LAG / FIRST_VALUE**: 이전 단계, 첫 단계 대비 계산

---

### 실무 활용

- 어느 단계에서 이탈이 가장 많은지 파악
- A/B 테스트 시 퍼널별 전환율 비교
- 마케팅 캠페인 효과 측정
