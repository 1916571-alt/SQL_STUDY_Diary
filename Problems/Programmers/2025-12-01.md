# 📅 2025-12-01 SQL Study Log
> **Platform**: Programmers
> **Topic**: DATEDIFF, String, Window Functions

---

## 🐶 1. 오랜 기간 보호한 동물(2)

입양을 간 동물 중, 보호 기간(`OUTS.DATETIME - INS.DATETIME`)이 가장 긴 동물 2마리 찾기.

### Sol 1: Simple ORDER BY
가장 직관적인 방법.
```sql
SELECT I.ANIMAL_ID, I.NAME
FROM ANIMAL_INS I
JOIN ANIMAL_OUTS O ON I.ANIMAL_ID = O.ANIMAL_ID
ORDER BY DATEDIFF(O.DATETIME, I.DATETIME) DESC
LIMIT 2;
```

### Sol 2: Window Function (ROW_NUMBER)
순위를 매겨 필터링하는 방식 (확장성 좋음).
```sql
WITH STAY_RANK AS(
    SELECT I.ANIMAL_ID, I.NAME,
           ROW_NUMBER() OVER (ORDER BY DATEDIFF(O.DATETIME, I.DATETIME) DESC) AS RN
    FROM ANIMAL_INS I
    JOIN ANIMAL_OUTS O ON I.ANIMAL_ID = O.ANIMAL_ID
)
SELECT ANIMAL_ID, NAME
FROM STAY_RANK
WHERE RN <= 2;
```

### 📝 순위 함수 비교
| 함수 | 특징 | 예시 |
| :--- | :--- | :--- |
| `ROW_NUMBER()` | 고유 순위 (중복 없음) | 1, 2, 3 |
| `RANK()` | 동점 건너뜀 | 1, 1, 3 |
| `DENSE_RANK()` | 동점 안 건너뜀 | 1, 1, 2 |

---

## 🚛 2. 자동차 대여 기록 별 대여 금액 구하기

트럭의 대여 기간(`DATEDIFF`)에 따라 할인율(`JOIN`)을 다르게 적용해야 하는 복합 문제.

### 핵심 로직: 구간 Grouping
`CASE WHEN`으로 대여 기간을 '7일 이상', '30일 이상' 등의 그룹 문자열로 변환하여 조인 키로 사용.

```sql
WITH SALES_GROUP AS (
    SELECT H.HISTORY_ID, C.CAR_TYPE, C.DAILY_FEE, 
           DATEDIFF(H.END_DATE, H.START_DATE) + 1 AS PERIOD,
           CASE
               WHEN DATEDIFF(...) + 1 >= 90 THEN '90일 이상'
               WHEN DATEDIFF(...) + 1 >= 30 THEN '30일 이상'
               WHEN DATEDIFF(...) + 1 >= 7  THEN '7일 이상'
               ELSE 'X' 
           END AS DURATION_TYPE
    FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY H
    JOIN CAR_RENTAL_COMPANY_CAR C ON H.CAR_ID = C.CAR_ID
    WHERE C.CAR_TYPE = '트럭'
)
SELECT G.HISTORY_ID,
       ROUND(G.DAILY_FEE * G.PERIOD * (1 - COALESCE(P.DISCOUNT_RATE, 0) / 100), 0) AS FEE
FROM SALES_GROUP G
LEFT JOIN CAR_RENTAL_COMPANY_DISCOUNT_PLAN P 
    ON G.CAR_TYPE = P.CAR_TYPE AND G.DURATION_TYPE = P.DURATION_TYPE
ORDER BY FEE DESC, G.HISTORY_ID DESC;
```
