-- ============================================
-- DB Fiddle 연습용 샘플 데이터 (MySQL 8.0)
-- https://www.db-fiddle.com/ 에서 사용
-- ============================================
-- 왼쪽 Schema SQL에 이 전체를 복사해서 붙여넣기
-- 오른쪽 Query SQL에 연습 쿼리 작성
-- ============================================

-- ============================================
-- 1. 기본 테이블 생성
-- ============================================

-- 사용자 테이블
CREATE TABLE users (
    id INT PRIMARY KEY,
    name VARCHAR(50),
    email VARCHAR(100),
    birth_date DATE,
    created_at DATETIME,
    utm_source VARCHAR(50)
);

-- 매장 테이블
CREATE TABLE stores (
    id INT PRIMARY KEY,
    name VARCHAR(100),
    region VARCHAR(50),
    opened_at DATE
);

-- 상품 테이블 (음료 메뉴)
CREATE TABLE products (
    id INT PRIMARY KEY,
    name VARCHAR(100),
    category VARCHAR(50),
    size VARCHAR(20),
    price INT
);

-- 주문 테이블
CREATE TABLE orders (
    id INT PRIMARY KEY,
    user_id INT,
    store_id INT,
    order_datetime DATETIME,
    total_amount INT
);

-- 주문 상세 테이블
CREATE TABLE order_items (
    id INT PRIMARY KEY,
    order_id INT,
    product_id INT,
    quantity INT,
    unit_price INT
);

-- 앱 로그 테이블
CREATE TABLE app_logs (
    id INT PRIMARY KEY,
    user_id INT,
    event_name VARCHAR(50),
    event_date DATE,
    event_time DATETIME
);

-- 마케팅 비용 테이블
CREATE TABLE marketing_costs (
    id INT PRIMARY KEY,
    year_month VARCHAR(7),
    channel VARCHAR(50),
    cost INT
);

-- 캠페인 테이블
CREATE TABLE campaigns (
    id INT PRIMARY KEY,
    name VARCHAR(100),
    target_segment VARCHAR(50),
    budget INT,
    sent_at DATETIME
);

-- 캠페인 발송 테이블
CREATE TABLE campaign_sends (
    id INT PRIMARY KEY,
    campaign_id INT,
    user_id INT,
    sent_at DATETIME
);

-- 캠페인 오픈 테이블
CREATE TABLE campaign_opens (
    id INT PRIMARY KEY,
    send_id INT,
    opened_at DATETIME
);

-- 캠페인 클릭 테이블
CREATE TABLE campaign_clicks (
    id INT PRIMARY KEY,
    send_id INT,
    clicked_at DATETIME
);

-- ============================================
-- 2. 샘플 데이터 삽입
-- ============================================

-- 사용자 데이터 (30명)
INSERT INTO users VALUES
(1, '김민수', 'minsu@email.com', '1990-03-15', '2024-01-05 10:30:00', 'google'),
(2, '이영희', 'younghee@email.com', '1988-07-22', '2024-01-07 14:20:00', 'instagram'),
(3, '박철수', 'chulsoo@email.com', '1995-11-08', '2024-01-10 09:15:00', 'google'),
(4, '정미영', 'miyoung@email.com', '1992-04-30', '2024-01-12 16:45:00', 'facebook'),
(5, '홍길동', 'gildong@email.com', '1985-09-17', '2024-01-15 11:00:00', 'organic'),
(6, '김서연', 'seoyeon@email.com', '1998-02-28', '2024-01-18 13:30:00', 'instagram'),
(7, '이준호', 'junho@email.com', '1991-06-12', '2024-01-20 08:45:00', 'google'),
(8, '박지민', 'jimin@email.com', '1993-12-05', '2024-01-22 15:20:00', 'facebook'),
(9, '최수진', 'sujin@email.com', '1989-08-19', '2024-01-25 10:10:00', 'organic'),
(10, '강태우', 'taewoo@email.com', '1996-01-25', '2024-01-28 12:00:00', 'instagram'),
(11, '윤하나', 'hana@email.com', '1994-05-14', '2024-02-01 09:30:00', 'google'),
(12, '장동건', 'donggun@email.com', '1987-10-03', '2024-02-05 14:15:00', 'facebook'),
(13, '송지효', 'jihyo@email.com', '1997-03-21', '2024-02-08 11:45:00', 'instagram'),
(14, '임재범', 'jaebum@email.com', '1990-07-09', '2024-02-12 16:30:00', 'organic'),
(15, '한소희', 'sohee@email.com', '1999-11-27', '2024-02-15 10:00:00', 'google'),
(16, '오민석', 'minseok@email.com', '1986-04-18', '2024-02-18 13:20:00', 'facebook'),
(17, '신예은', 'yeeun@email.com', '1995-08-06', '2024-02-22 08:50:00', 'instagram'),
(18, '권혁수', 'hyuksoo@email.com', '1992-12-14', '2024-02-25 15:40:00', 'google'),
(19, '백지영', 'jiyoung@email.com', '1988-02-02', '2024-03-01 11:15:00', 'organic'),
(20, '남궁민', 'namgoong@email.com', '1993-06-28', '2024-03-05 14:00:00', 'instagram'),
(21, '서현진', 'hyunjin@email.com', '1991-09-11', '2024-03-08 09:45:00', 'google'),
(22, '유재석', 'jaeseok@email.com', '1985-01-30', '2024-03-12 12:30:00', 'facebook'),
(23, '전지현', 'jihyun@email.com', '1997-05-19', '2024-03-15 16:10:00', 'organic'),
(24, '조인성', 'insung@email.com', '1989-11-07', '2024-03-18 10:55:00', 'instagram'),
(25, '김태희', 'taehee@email.com', '1994-03-25', '2024-03-22 13:40:00', 'google'),
(26, '이병헌', 'byunghun@email.com', '1986-08-13', '2024-03-25 08:20:00', 'facebook'),
(27, '손예진', 'yejin@email.com', '1996-12-01', '2024-03-28 15:05:00', 'organic'),
(28, '현빈', 'hyunbin@email.com', '1990-10-20', '2024-04-01 11:30:00', 'instagram'),
(29, '공유', 'gongyoo@email.com', '1988-04-08', '2024-04-05 14:45:00', 'google'),
(30, '수지', 'suzy@email.com', '1998-07-16', '2024-04-08 09:00:00', 'facebook');

-- 매장 데이터 (5개)
INSERT INTO stores VALUES
(1, '강남점', '서울', '2023-01-15'),
(2, '홍대점', '서울', '2023-03-20'),
(3, '판교점', '경기', '2023-06-01'),
(4, '해운대점', '부산', '2023-09-10'),
(5, '동성로점', '대구', '2023-11-25');

-- 상품 데이터 (15개 음료)
INSERT INTO products VALUES
(1, '아메리카노', '커피', 'Regular', 4500),
(2, '아메리카노', '커피', 'Large', 5000),
(3, '카페라떼', '커피', 'Regular', 5000),
(4, '카페라떼', '커피', 'Large', 5500),
(5, '바닐라라떼', '커피', 'Regular', 5500),
(6, '바닐라라떼', '커피', 'Large', 6000),
(7, '카라멜마끼아또', '커피', 'Regular', 5800),
(8, '카라멜마끼아또', '커피', 'Large', 6300),
(9, '녹차라떼', '논커피', 'Regular', 5500),
(10, '녹차라떼', '논커피', 'Large', 6000),
(11, '초코라떼', '논커피', 'Regular', 5500),
(12, '초코라떼', '논커피', 'Large', 6000),
(13, '딸기스무디', '스무디', 'Regular', 6000),
(14, '망고스무디', '스무디', 'Regular', 6000),
(15, '플레인요거트', '디저트', 'Regular', 4000);

-- 주문 데이터 (100건)
INSERT INTO orders VALUES
-- 1월 주문
(1, 1, 1, '2024-01-06 08:30:00', 4500),
(2, 1, 1, '2024-01-10 09:15:00', 5000),
(3, 1, 1, '2024-01-15 08:45:00', 9500),
(4, 2, 2, '2024-01-08 14:30:00', 5500),
(5, 2, 2, '2024-01-20 15:00:00', 11000),
(6, 3, 1, '2024-01-12 10:00:00', 5000),
(7, 3, 1, '2024-01-18 09:30:00', 4500),
(8, 3, 3, '2024-01-25 11:15:00', 10000),
(9, 4, 2, '2024-01-15 16:00:00', 5800),
(10, 5, 1, '2024-01-17 11:30:00', 6000),
-- 2월 주문
(11, 1, 1, '2024-02-01 08:20:00', 4500),
(12, 1, 1, '2024-02-05 09:00:00', 5500),
(13, 1, 1, '2024-02-10 08:40:00', 4500),
(14, 1, 1, '2024-02-15 09:10:00', 5000),
(15, 2, 2, '2024-02-03 14:45:00', 6000),
(16, 2, 2, '2024-02-18 15:30:00', 5500),
(17, 3, 1, '2024-02-02 10:15:00', 4500),
(18, 3, 3, '2024-02-08 11:00:00', 5000),
(19, 3, 1, '2024-02-14 09:45:00', 9000),
(20, 3, 1, '2024-02-20 10:30:00', 4500),
(21, 4, 2, '2024-02-05 16:15:00', 5800),
(22, 4, 2, '2024-02-25 17:00:00', 6300),
(23, 5, 1, '2024-02-10 11:45:00', 5500),
(24, 5, 4, '2024-02-22 12:30:00', 6000),
(25, 6, 2, '2024-02-01 13:00:00', 5000),
(26, 6, 2, '2024-02-08 14:15:00', 5500),
(27, 6, 2, '2024-02-15 13:30:00', 4500),
(28, 7, 1, '2024-02-03 08:50:00', 4500),
(29, 7, 1, '2024-02-10 09:20:00', 5000),
(30, 8, 3, '2024-02-05 15:00:00', 6000),
-- 3월 주문
(31, 1, 1, '2024-03-01 08:15:00', 4500),
(32, 1, 1, '2024-03-05 09:00:00', 4500),
(33, 1, 1, '2024-03-10 08:30:00', 5500),
(34, 1, 1, '2024-03-15 09:15:00', 4500),
(35, 1, 1, '2024-03-20 08:45:00', 5000),
(36, 2, 2, '2024-03-03 14:30:00', 5500),
(37, 2, 2, '2024-03-12 15:15:00', 6000),
(38, 2, 2, '2024-03-22 14:45:00', 5500),
(39, 3, 1, '2024-03-02 10:00:00', 4500),
(40, 3, 1, '2024-03-08 09:30:00', 5000),
(41, 3, 3, '2024-03-15 11:00:00', 5500),
(42, 3, 1, '2024-03-22 10:15:00', 4500),
(43, 3, 1, '2024-03-28 09:45:00', 9500),
(44, 4, 2, '2024-03-05 16:30:00', 5800),
(45, 4, 2, '2024-03-18 17:15:00', 5800),
(46, 5, 1, '2024-03-08 11:30:00', 6000),
(47, 5, 4, '2024-03-20 12:00:00', 5500),
(48, 6, 2, '2024-03-01 13:15:00', 4500),
(49, 6, 2, '2024-03-10 14:00:00', 5000),
(50, 6, 2, '2024-03-18 13:45:00', 5500),
(51, 6, 2, '2024-03-25 14:30:00', 4500),
(52, 7, 1, '2024-03-05 08:45:00', 4500),
(53, 7, 1, '2024-03-12 09:15:00', 5500),
(54, 7, 1, '2024-03-20 08:30:00', 4500),
(55, 8, 3, '2024-03-08 15:15:00', 5500),
(56, 8, 3, '2024-03-22 16:00:00', 6000),
(57, 9, 1, '2024-03-10 10:30:00', 5000),
(58, 9, 1, '2024-03-25 11:15:00', 5500),
(59, 10, 2, '2024-03-05 12:00:00', 6000),
(60, 10, 2, '2024-03-15 12:45:00', 5500),
-- 4월 주문
(61, 1, 1, '2024-04-01 08:20:00', 4500),
(62, 1, 1, '2024-04-05 09:00:00', 5000),
(63, 1, 1, '2024-04-10 08:35:00', 4500),
(64, 2, 2, '2024-04-02 14:30:00', 5500),
(65, 2, 2, '2024-04-15 15:00:00', 6000),
(66, 3, 1, '2024-04-03 10:00:00', 4500),
(67, 3, 1, '2024-04-08 09:30:00', 5000),
(68, 3, 3, '2024-04-15 11:00:00', 5500),
(69, 5, 1, '2024-04-05 11:30:00', 5500),
(70, 5, 4, '2024-04-18 12:15:00', 6000),
(71, 6, 2, '2024-04-02 13:00:00', 4500),
(72, 6, 2, '2024-04-10 14:00:00', 5500),
(73, 6, 2, '2024-04-18 13:30:00', 5000),
(74, 7, 1, '2024-04-03 08:45:00', 4500),
(75, 7, 1, '2024-04-12 09:20:00', 5000),
(76, 11, 1, '2024-04-05 09:30:00', 5000),
(77, 11, 1, '2024-04-12 10:00:00', 5500),
(78, 12, 3, '2024-04-08 14:15:00', 6000),
(79, 13, 2, '2024-04-10 11:45:00', 5500),
(80, 13, 2, '2024-04-18 12:30:00', 6000),
(81, 14, 1, '2024-04-15 16:30:00', 5000),
(82, 15, 4, '2024-04-18 10:00:00', 5500),
(83, 15, 4, '2024-04-25 10:45:00', 6000),
(84, 16, 2, '2024-04-20 13:20:00', 5800),
(85, 17, 5, '2024-04-22 08:50:00', 4500),
(86, 17, 5, '2024-04-28 09:15:00', 5000),
(87, 18, 1, '2024-04-25 15:40:00', 5500),
(88, 19, 3, '2024-04-28 11:15:00', 6000),
(89, 20, 2, '2024-04-30 14:00:00', 5000),
(90, 21, 1, '2024-04-08 09:45:00', 4500),
(91, 21, 1, '2024-04-15 10:15:00', 5000),
(92, 21, 1, '2024-04-22 09:30:00', 4500),
(93, 22, 3, '2024-04-12 12:30:00', 5500),
(94, 23, 4, '2024-04-18 16:10:00', 6000),
(95, 24, 2, '2024-04-20 10:55:00', 5500),
(96, 25, 1, '2024-04-22 13:40:00', 5000),
(97, 26, 5, '2024-04-25 08:20:00', 4500),
(98, 27, 4, '2024-04-28 15:05:00', 5500),
(99, 28, 2, '2024-04-02 11:30:00', 6000),
(100, 29, 1, '2024-04-08 14:45:00', 5000);

-- 주문 상세 데이터 (일부)
INSERT INTO order_items VALUES
(1, 1, 1, 1, 4500),
(2, 2, 2, 1, 5000),
(3, 3, 1, 1, 4500),
(4, 3, 3, 1, 5000),
(5, 4, 5, 1, 5500),
(6, 5, 5, 2, 5500),
(7, 6, 2, 1, 5000),
(8, 7, 1, 1, 4500),
(9, 8, 3, 2, 5000),
(10, 9, 7, 1, 5800),
(11, 10, 6, 1, 6000),
(12, 11, 1, 1, 4500),
(13, 12, 5, 1, 5500),
(14, 13, 1, 1, 4500),
(15, 14, 2, 1, 5000);

-- 앱 로그 데이터 (사용자 활동)
INSERT INTO app_logs VALUES
-- 사용자 1 (활발한 사용자)
(1, 1, 'app_open', '2024-01-06', '2024-01-06 08:25:00'),
(2, 1, 'view_menu', '2024-01-06', '2024-01-06 08:27:00'),
(3, 1, 'order_complete', '2024-01-06', '2024-01-06 08:30:00'),
(4, 1, 'app_open', '2024-01-10', '2024-01-10 09:10:00'),
(5, 1, 'order_complete', '2024-01-10', '2024-01-10 09:15:00'),
(6, 1, 'app_open', '2024-01-15', '2024-01-15 08:40:00'),
(7, 1, 'order_complete', '2024-01-15', '2024-01-15 08:45:00'),
(8, 1, 'app_open', '2024-02-01', '2024-02-01 08:15:00'),
(9, 1, 'order_complete', '2024-02-01', '2024-02-01 08:20:00'),
(10, 1, 'app_open', '2024-02-05', '2024-02-05 08:55:00'),
(11, 1, 'order_complete', '2024-02-05', '2024-02-05 09:00:00'),
(12, 1, 'app_open', '2024-02-10', '2024-02-10 08:35:00'),
(13, 1, 'order_complete', '2024-02-10', '2024-02-10 08:40:00'),
(14, 1, 'app_open', '2024-03-01', '2024-03-01 08:10:00'),
(15, 1, 'order_complete', '2024-03-01', '2024-03-01 08:15:00'),
-- 사용자 2
(16, 2, 'app_open', '2024-01-08', '2024-01-08 14:25:00'),
(17, 2, 'order_complete', '2024-01-08', '2024-01-08 14:30:00'),
(18, 2, 'app_open', '2024-01-20', '2024-01-20 14:55:00'),
(19, 2, 'order_complete', '2024-01-20', '2024-01-20 15:00:00'),
(20, 2, 'app_open', '2024-02-03', '2024-02-03 14:40:00'),
(21, 2, 'order_complete', '2024-02-03', '2024-02-03 14:45:00'),
(22, 2, 'app_open', '2024-03-03', '2024-03-03 14:25:00'),
(23, 2, 'order_complete', '2024-03-03', '2024-03-03 14:30:00'),
-- 사용자 3 (자주 방문)
(24, 3, 'app_open', '2024-01-12', '2024-01-12 09:55:00'),
(25, 3, 'order_complete', '2024-01-12', '2024-01-12 10:00:00'),
(26, 3, 'app_open', '2024-01-18', '2024-01-18 09:25:00'),
(27, 3, 'order_complete', '2024-01-18', '2024-01-18 09:30:00'),
(28, 3, 'app_open', '2024-01-25', '2024-01-25 11:10:00'),
(29, 3, 'order_complete', '2024-01-25', '2024-01-25 11:15:00'),
(30, 3, 'app_open', '2024-02-02', '2024-02-02 10:10:00'),
(31, 3, 'order_complete', '2024-02-02', '2024-02-02 10:15:00'),
(32, 3, 'app_open', '2024-02-08', '2024-02-08 10:55:00'),
(33, 3, 'order_complete', '2024-02-08', '2024-02-08 11:00:00'),
(34, 3, 'app_open', '2024-02-14', '2024-02-14 09:40:00'),
(35, 3, 'order_complete', '2024-02-14', '2024-02-14 09:45:00'),
-- 사용자 4 (간헐적)
(36, 4, 'app_open', '2024-01-15', '2024-01-15 15:55:00'),
(37, 4, 'order_complete', '2024-01-15', '2024-01-15 16:00:00'),
(38, 4, 'app_open', '2024-02-05', '2024-02-05 16:10:00'),
(39, 4, 'order_complete', '2024-02-05', '2024-02-05 16:15:00'),
-- 사용자 5
(40, 5, 'app_open', '2024-01-17', '2024-01-17 11:25:00'),
(41, 5, 'order_complete', '2024-01-17', '2024-01-17 11:30:00'),
(42, 5, 'app_open', '2024-02-10', '2024-02-10 11:40:00'),
(43, 5, 'order_complete', '2024-02-10', '2024-02-10 11:45:00'),
-- 이탈 위험 사용자 (오래 접속 안함)
(44, 8, 'app_open', '2024-02-05', '2024-02-05 14:55:00'),
(45, 8, 'order_complete', '2024-02-05', '2024-02-05 15:00:00'),
(46, 9, 'app_open', '2024-03-10', '2024-03-10 10:25:00'),
(47, 9, 'order_complete', '2024-03-10', '2024-03-10 10:30:00');

-- 마케팅 비용 데이터
INSERT INTO marketing_costs VALUES
(1, '2024-01', 'google', 5000000),
(2, '2024-01', 'instagram', 3000000),
(3, '2024-01', 'facebook', 2000000),
(4, '2024-02', 'google', 6000000),
(5, '2024-02', 'instagram', 4000000),
(6, '2024-02', 'facebook', 2500000),
(7, '2024-03', 'google', 7000000),
(8, '2024-03', 'instagram', 5000000),
(9, '2024-03', 'facebook', 3000000),
(10, '2024-04', 'google', 8000000),
(11, '2024-04', 'instagram', 6000000),
(12, '2024-04', 'facebook', 3500000);

-- 캠페인 데이터
INSERT INTO campaigns VALUES
(1, '1월 신규가입 환영', 'new_user', 1000000, '2024-01-15 10:00:00'),
(2, '2월 재방문 유도', 'dormant', 800000, '2024-02-10 10:00:00'),
(3, '3월 VIP 감사', 'vip', 500000, '2024-03-01 10:00:00'),
(4, '4월 봄맞이 프로모션', 'all', 1500000, '2024-04-01 10:00:00');

-- 캠페인 발송 데이터
INSERT INTO campaign_sends VALUES
(1, 1, 1, '2024-01-15 10:00:00'),
(2, 1, 2, '2024-01-15 10:00:00'),
(3, 1, 3, '2024-01-15 10:00:00'),
(4, 1, 4, '2024-01-15 10:00:00'),
(5, 1, 5, '2024-01-15 10:00:00'),
(6, 2, 4, '2024-02-10 10:00:00'),
(7, 2, 8, '2024-02-10 10:00:00'),
(8, 2, 9, '2024-02-10 10:00:00'),
(9, 3, 1, '2024-03-01 10:00:00'),
(10, 3, 3, '2024-03-01 10:00:00'),
(11, 3, 6, '2024-03-01 10:00:00'),
(12, 4, 1, '2024-04-01 10:00:00'),
(13, 4, 2, '2024-04-01 10:00:00'),
(14, 4, 3, '2024-04-01 10:00:00'),
(15, 4, 5, '2024-04-01 10:00:00'),
(16, 4, 6, '2024-04-01 10:00:00'),
(17, 4, 7, '2024-04-01 10:00:00'),
(18, 4, 10, '2024-04-01 10:00:00'),
(19, 4, 11, '2024-04-01 10:00:00'),
(20, 4, 12, '2024-04-01 10:00:00');

-- 캠페인 오픈 데이터
INSERT INTO campaign_opens VALUES
(1, 1, '2024-01-15 10:05:00'),
(2, 2, '2024-01-15 10:10:00'),
(3, 3, '2024-01-15 10:08:00'),
(4, 5, '2024-01-15 10:15:00'),
(5, 6, '2024-02-10 10:12:00'),
(6, 9, '2024-03-01 10:20:00'),
(7, 10, '2024-03-01 10:18:00'),
(8, 12, '2024-04-01 10:03:00'),
(9, 13, '2024-04-01 10:07:00'),
(10, 14, '2024-04-01 10:05:00'),
(11, 15, '2024-04-01 10:10:00'),
(12, 17, '2024-04-01 10:08:00'),
(13, 19, '2024-04-01 10:15:00');

-- 캠페인 클릭 데이터
INSERT INTO campaign_clicks VALUES
(1, 1, '2024-01-15 10:06:00'),
(2, 3, '2024-01-15 10:09:00'),
(3, 6, '2024-02-10 10:15:00'),
(4, 10, '2024-03-01 10:20:00'),
(5, 12, '2024-04-01 10:05:00'),
(6, 14, '2024-04-01 10:08:00'),
(7, 17, '2024-04-01 10:12:00');


-- ============================================
-- 3. 연습 쿼리 예시
-- ============================================

-- ============================================
-- [G-1] 고객별 평균 구매 주기 분석
-- ============================================
/*
WITH order_intervals AS (
    SELECT
        user_id,
        order_datetime,
        LAG(order_datetime) OVER (PARTITION BY user_id ORDER BY order_datetime) AS prev_order,
        DATEDIFF(order_datetime, LAG(order_datetime) OVER (PARTITION BY user_id ORDER BY order_datetime)) AS days_between
    FROM orders
)
SELECT
    o.user_id,
    u.name,
    COUNT(*) AS order_count,
    ROUND(AVG(days_between), 1) AS avg_purchase_interval_days,
    MAX(o.order_datetime) AS last_order_date
FROM order_intervals o
JOIN users u ON o.user_id = u.id
WHERE days_between IS NOT NULL
GROUP BY o.user_id, u.name
HAVING COUNT(*) >= 2
ORDER BY avg_purchase_interval_days;
*/

-- ============================================
-- [G-7] 재주문율 분석
-- ============================================
/*
WITH first_orders AS (
    SELECT
        user_id,
        MIN(order_datetime) AS first_order_date,
        DATE_FORMAT(MIN(order_datetime), '%Y-%m') AS first_order_month
    FROM orders
    GROUP BY user_id
),
repeat_orders AS (
    SELECT
        f.user_id,
        f.first_order_month,
        MIN(o.order_datetime) AS second_order_date,
        DATEDIFF(MIN(o.order_datetime), f.first_order_date) AS days_to_repeat
    FROM first_orders f
    JOIN orders o ON f.user_id = o.user_id
        AND o.order_datetime > f.first_order_date
    GROUP BY f.user_id, f.first_order_month, f.first_order_date
)
SELECT
    f.first_order_month,
    COUNT(DISTINCT f.user_id) AS first_purchasers,
    COUNT(DISTINCT r.user_id) AS repeat_purchasers,
    ROUND(COUNT(DISTINCT r.user_id) / COUNT(DISTINCT f.user_id) * 100, 1) AS repeat_rate,
    ROUND(AVG(r.days_to_repeat), 1) AS avg_days_to_repeat
FROM first_orders f
LEFT JOIN repeat_orders r ON f.user_id = r.user_id
GROUP BY f.first_order_month
ORDER BY f.first_order_month;
*/
