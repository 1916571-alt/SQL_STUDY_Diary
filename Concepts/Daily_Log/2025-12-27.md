# ğŸ“… 2025-12-27 SQL Study Log
> **Platform**: SolveSQL
> **Topic**: Graph (Friends), Pivot Table

---

## ğŸ‘¥ 1. ì¸í”Œë£¨ì–¸ì„œ ë§ˆì¼€íŒ… í›„ë³´ ì°¾ê¸° (Level 5)
**ëª©í‘œ**: ì¹œêµ¬ì˜ ì¹œêµ¬(2-hop) ìˆ˜ê°€ ë§ì€ ìƒìœ„ ìœ ì € 5ëª… ì¶”ì¶œ.

### âŒ ì´ˆê¸° ì‹œë„ (ì‹¤íŒ¨)
`user_a_id` -> `user_b_id` ë‹¨ë°©í–¥ë§Œ ê³ ë ¤í•¨. ì¹œêµ¬ ê´€ê³„ëŠ” ì–‘ë°©í–¥(Aê°€ Bì˜ ì¹œêµ¬ë©´ Bë„ Aì˜ ì¹œêµ¬)ì„ì„ ê°„ê³¼.

### âœ… í•´ê²°ì±… (Union Allë¡œ ë¬´ë°©í–¥í™”)
ë¨¼ì € ëª¨ë“  ê´€ê³„ë¥¼ `(user_id, friend_id)` í˜•íƒœë¡œ í’€ì–´ì„œ 2ë°°ë¡œ ë¶ˆë¦° ë’¤ ì‹œì‘í•œë‹¤.

```sql
WITH friends AS (
    -- 1. ê´€ê³„ í¼ì¹˜ê¸° (A->B, B->A ëª¨ë‘ í¬í•¨)
    SELECT user_a_id AS user_id, user_b_id AS friend_id FROM edges
    UNION ALL
    SELECT user_b_id AS user_id, user_a_id AS friend_id FROM edges
),
degree AS (
    -- 2. ë‚´ ì§ì ‘ ì¹œêµ¬ ìˆ˜
    SELECT user_id, COUNT(*) AS friends
    FROM friends
    GROUP BY user_id
),
fof_sum AS (
    -- 3. ë‚´ ì¹œêµ¬ë“¤ì˜ ì¹œêµ¬ ìˆ˜ í•©ì‚°
    SELECT f.user_id, SUM(d.friends) AS friends_of_friends
    FROM friends f
    JOIN degree d ON f.friend_id = d.user_id
    GROUP BY f.user_id
)
SELECT 
    d.user_id, d.friends, f.friends_of_friends,
    ROUND(f.friends_of_friends / d.friends, 2) AS ratio
FROM degree d
JOIN fof_sum f ON d.user_id = f.user_id
WHERE d.friends >= 100
ORDER BY ratio DESC
LIMIT 5;
```

---

## ğŸ“¦ 2. ì—°ë„ë³„ ë°°ì†¡ ì—…ì²´ ì´ìš© ë‚´ì—­

### ğŸ’¡ Core Insight: Pivot Pattern
`Standard`, `Express` ë“±ì˜ í–‰(Row) ê°’ì„ ì»¬ëŸ¼(Column)ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ í•©ì‚°í•´ì•¼ í•¨.

### Recommended Code
`SUM(CASE WHEN ... THEN 1 ELSE 0 END)`ì„ ì‚¬ìš©í•˜ë©´ CTE ì—†ì´ í•œ ë²ˆì— í•´ê²° ê°€ëŠ¥.

```sql
SELECT 
    YEAR(purchased_at) AS year,
    -- StandardëŠ” ë°˜í’ˆ ê±´ìˆ˜ë„ í¬í•¨
    SUM(CASE WHEN shipping_method = 'Standard' THEN 1 ELSE 0 END) + SUM(is_returned) AS standard,
    SUM(CASE WHEN shipping_method = 'Express' THEN 1 ELSE 0 END) AS express,
    SUM(CASE WHEN shipping_method = 'Overnight' THEN 1 ELSE 0 END) AS overnight
FROM transactions
WHERE shipping_method IS NOT NULL
GROUP BY YEAR(purchased_at)
ORDER BY year;
```
